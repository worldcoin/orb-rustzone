name: Release
on:
  push: 
    branches:
      - 'main'

permissions: {}

jobs:
  ta:
    name: TA
    uses: ./.github/workflows/ta.yaml
    with:
      prod: ${{ github.ref_name == github.event.repository.default_branch }}
      source: ${{ github.sha }}
      cargo_profile: artifact
    permissions:
      contents: read
      id-token: write
    secrets: inherit

  release:
    name: Create Release and Tag
    runs-on: ubuntu-24.04
    needs: [ta]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # pin@v6.0.1
      - name: Compute truncated git commit
        id: compute_version
        run: echo "short_sha=${GITHUB_SHA:0:16}" >> "$GITHUB_OUTPUT"
      - name: Download TA Debs
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # pin@v7.0.0
        with:
          name: ta_deb
          path: artifacts

      - name: List Downloaded Artifacts
        run: ls -aRsh artifacts

      - name: Compute sha256 checksums
        run: |
          set -Eeuxo pipefail
          pushd artifacts
          for f in *; do
            sha256sum "${f}" > "${f}.sha256"
          done
          ls -aRsh
          popd



      - name: Upload Release and Create Tag
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # pin@v1
        if: ${{ github.ref_name == github.event.repository.default_branch }}
        with:
          tag_name: git-${{ steps.compute_version.outputs.short_sha }}
          fail_on_unmatched_files: true
          overwrite_files: false
          files: artifacts/*
